<!DOCTYPE html>
<html>
  <head>
    <title>LCBC online study</title>
    <script src="jspsych.js"></script>
    <script src="plugins/jspsych-html-button-response.js"></script>
    <script src="plugins/jspsych-html-keyboard-response.js"></script>
    <script src="plugins/jspsych-image-button-response.js"></script>
    <script src="plugins/jspsych-image-keyboard-response.js"></script>
    <script src="plugins/jspsych-fullscreen.js"></script>
    <script src="plugins/jspsych-resize.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/jspsych.css">
  </head>
  <body>
    <script>
    /* create timeline */
    var timeline = [];

    /* define welcome message trial */
    timeline.push({
      type: "html-keyboard-response",
      stimulus: "<p>This experiment can only be completed <b>once</b>.<br>" +
                "Please only continue, if you were explicitly asked to do so.</p>" +
                "<p class='small'>Press the 'y' key to begin.</p>",
      choices: ['y','z']
    });

    /* start fullscreen */
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: true
    });

    function mm_to_scaled_px(mm) {
      return 3 * mm;
    }
    
    /* calibrate display size */
    timeline.push({
      type: 'resize',
      item_width: 86,
      item_height: 54,
      prompt: 
        "<p>Click and drag the lower right corner of the box<br>" + 
        "until the box is the same size as a credit card held up to the screen.</p>",
      pixels_per_unit: 3,
      data: { image_type: 'A' },
    });

    /* prepare test */
    timeline.push({
      type: "html-keyboard-response",
      stimulus: "<p>Any image will be shown on the next screen.<br>" + 
                "You have 5 minutes to draw the image.</p>" +
                "<p>Press any key to continue.</p>",
    });

    /* show image */
    timeline.push({
      type: "html-button-response",
      stimulus: 
        "<p>Draw the image</p>" +
        `<img style='width: ${mm_to_scaled_px(130)}px;' src='img/input.png'></img>` +
        '<div class="progress my-3"><div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div></div>',
      choices: ["I'm already done"],
      trial_duration: 5 * 60 * 1000,
      on_finish: function(data){
        data.date = (new Date).toISOString();
      },
      on_load: () => {
        const duration_ms = 5 * 60 * 1000;
        var start_date = new Date();
        var end_date = new Date();
        end_date.setMilliseconds(start_date.getMilliseconds() + duration_ms);
        var width = 1;
        var id = setInterval(frame, 300);
        function frame() {
          if (width >= 100) {
            clearInterval(id);
          } else {
            var now = new Date().getTime();
            elapsed_ms = now - start_date;
            width = Math.pow((elapsed_ms / duration_ms), 3) * 100;
            var elem = document.getElementById("progressBar");
            if (elem == null) {
              clearInterval(id);
              return;
            }
            elem.style.width = width + "%";
          }
        }
      },
    });

    /* end fullscreen */
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: false
    });

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function(data) {
        // save in PsyDev Oslo:
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "../../save";
        const hiddenFieldUrl = document.createElement('input');
        hiddenFieldUrl.type = 'hidden';
        hiddenFieldUrl.name = "url";
        hiddenFieldUrl.value = window.location.pathname;
        form.appendChild(hiddenFieldUrl);
        const hiddenFieldResults = document.createElement('input');
        hiddenFieldResults.type = 'hidden';
        hiddenFieldResults.name = "results";
        hiddenFieldResults.value = JSON.stringify(data.json());
        form.appendChild(hiddenFieldResults);
        document.body.appendChild(form);
        form.submit();
      }
    });
  </script>
  </body>
</html>
